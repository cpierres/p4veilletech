# Configuration principale Nginx (Docker)
user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log  warn;
pid        /var/run/nginx.pid;

events {
  worker_connections  1024;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  access_log  /var/log/nginx/access.log;

  sendfile        on;
  keepalive_timeout  65s;

  # Optimisations générales (optionnel)
  # gzip on;
  # gzip_types text/plain application/javascript text/css application/json application/xml;

  # Serveur par défaut HTTP (préprod locale). En prod, mettez un bloc 443 avec TLS.
  server {
    listen 80;
    # noms hôtes: localhost (dev), cv.cpierres.dscloud.me (prod), nascpi8 (NAS)
    server_name localhost cpierres.dscloud.me nascpi8;

    # Racine des fichiers de l'application Angular (build Angular universel -> /browser)
    root /usr/share/nginx/html/browser;
    index index.html;

    # -------- API générique vers backend Spring --------
    # Conserve le schéma d’en‑têtes standards et la compatibilité WebFlux
    location ^~ /api/ {
      proxy_pass http://backend:8080/api/; # trailing slash pour réécrire /api/ -> /api/
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      # Si on a des réponses SSE ailleurs que /api/chat, on pourrait désactiver le buffering ici aussi
      # proxy_buffering off;
      # add_header X-Accel-Buffering no;
    }

    # -------- SSE (Server-Sent Events) pour /api/chat --------
    # Produit text/event-stream: il faut désactiver le buffering pour un streaming fluide
    location = /api/chat {
      proxy_pass http://backend:8080; # pas de trailing slash -> conserve l’URI /api/chat
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_buffering off;
      add_header X-Accel-Buffering no;
      proxy_read_timeout 1h; # laisse le flux s’ouvrir longtemps
    }

    # -------- Webhook GitHub --------
    # Doit accepter uniquement POST, ne pas bufferiser, timeouts raisonnables, pas de cache
    location = /webhook/github {
      # Limiter aux requêtes POST (les autres reçoivent 405)
      # limit_except POST { return 405; }

      proxy_pass http://backend:8080/webhook/github;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_read_timeout 30s;
      client_max_body_size 2m; # payloads de webhook sont petits
      add_header Cache-Control "no-store";

      # (Option) Restreindre par IP GitHub — TODO activer en fonction liste des ranges GitHub
      # Voir: https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/about-githubs-ip-addresses
      # allow 140.82.112.0/20;   # exemples historiques, à vérifier avant d'activer
      # allow 185.199.108.0/22;
      # allow 192.30.252.0/22;
      # deny all;
    }

    # -------- Endpoint d’admin: sync-all --------
    # À PROTÉGER en prod (auth, IP allowlist). Ici: POST uniquement.
    location = /admin/github/sync-all {
#       limit_except POST {
#           deny all;
#       }

      proxy_pass http://backend:8080/admin/github/sync-all;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_read_timeout 90s; # selon la volumétrie, peut prendre un peu de temps
      add_header Cache-Control "no-store";

      # (Option forte) Protéger cet endpoint: Basic Auth côté Nginx
      # auth_basic "Restricted";
      # auth_basic_user_file /etc/nginx/.htpasswd; # générez avec `htpasswd`

      # (Option alternative) Restreindre par IP locale / réseau admin
      # allow 127.0.0.1;
      # allow 192.168.0.0/16;
      # deny all;
    }

    # -------- Fichiers statiques de la SPA Angular --------
    # Fallback SPA: renvoie index.html pour les routes front
    location / {
      try_files $uri /index.html;
    }

    # (Option) Healthcheck simple si on sert un fichier dédié
    # location = /healthz { return 200 "ok"; add_header Content-Type text/plain; }
  }
}
