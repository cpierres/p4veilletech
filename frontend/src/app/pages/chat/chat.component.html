<div class="chat-container">
  <div class="chat-header">
    <h2>Chatbot CV ‚Äî RAG</h2>
    <div class="header-controls">
      <mat-form-field appearance="outline" class="lang-select">
        <mat-label>Langue / Language</mat-label>
        <mat-select [value]="lang()" (valueChange)="lang.set($event)">
          <mat-option value="fr">Fran√ßais</mat-option>
          <mat-option value="en">English</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="provider-select">
        <mat-label>{{ lang()==='fr' ? 'Fournisseur IA' : 'AI Provider' }}</mat-label>
        <mat-select [value]="provider()" (valueChange)="provider.set($event)">
          <mat-option value="openai">OpenAI</mat-option>
          <mat-option value="mistral">Mistral AI</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="model-select">
        <mat-label>{{ lang()==='fr' ? 'Mod√®le' : 'Model' }}</mat-label>
        <mat-select [value]="model()" (valueChange)="model.set($event)">
          <mat-option *ngFor="let m of availableModels()" [value]="m.value">{{ m.label }}</mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-icon-button type="button" (click)="showAdvancedSettings.set(!showAdvancedSettings())"
              [matTooltip]="lang()==='fr' ? 'Param√®tres avanc√©s' : 'Advanced settings'">
        ‚öôÔ∏è
      </button>
    </div>
  </div>

  <!-- Param√®tres avanc√©s -->
  <div class="advanced-settings" *ngIf="showAdvancedSettings()">
    <div class="settings-row">
      <mat-form-field appearance="outline" class="setting-field">
        <mat-label>{{ lang()==='fr' ? 'Temp√©rature' : 'Temperature' }} (0-2)</mat-label>
        <input matInput type="number" [ngModel]="temperature()" (ngModelChange)="temperature.set($event)"
               min="0" max="2" step="0.1" name="temperature"/>
      </mat-form-field>

      <mat-form-field appearance="outline" class="setting-field">
        <mat-label>Top P (0-1)</mat-label>
        <input matInput type="number" [ngModel]="topP()" (ngModelChange)="topP.set($event)"
               min="0" max="1" step="0.1" name="topP"/>
      </mat-form-field>

      <mat-form-field appearance="outline" class="setting-field">
        <mat-label>{{ lang()==='fr' ? 'Max Tokens' : 'Max Tokens' }}</mat-label>
        <input matInput type="number" [ngModel]="maxTokens()" (ngModelChange)="maxTokens.set($event)"
               min="100" max="4096" step="100" name="maxTokens"/>
      </mat-form-field>
    </div>

    <div class="settings-row">
      <mat-form-field appearance="outline" class="setting-field">
        <mat-label>RAG Top K</mat-label>
        <input matInput type="number" [ngModel]="ragTopK()" (ngModelChange)="ragTopK.set($event)"
               min="1" max="50" step="1" name="ragTopK"/>
      </mat-form-field>

      <mat-form-field appearance="outline" class="setting-field">
        <mat-label>{{ lang()==='fr' ? 'Seuil similarit√© RAG' : 'RAG Similarity Threshold' }}</mat-label>
        <input matInput type="number" [ngModel]="ragSimilarityThreshold()" (ngModelChange)="ragSimilarityThreshold.set($event)"
               min="0" max="1" step="0.05" name="ragSimilarityThreshold"/>
      </mat-form-field>
    </div>
  </div>

  <div class="messages" #messagesContainer>
    <div *ngFor="let m of messages(); let i = index" [class.user]="m.role==='user'" [class.assistant]="m.role==='assistant'" class="message">
      <div class="bubble">
        <div [innerHTML]="renderMarkdown(m.text)"></div>
        <div class="bubble-footer" *ngIf="m.role==='assistant' && m.text && m.text.trim()">
          <div class="metadata-badge" *ngIf="m.metadata">
            <span *ngIf="m.metadata.provider">ü§ñ {{ m.metadata.provider }}</span>
            <span *ngIf="m.metadata.model">üì¶ {{ m.metadata.model }}</span>
            <span *ngIf="m.metadata.processingTimeMs">‚è±Ô∏è {{ m.metadata.processingTimeMs }}ms</span>
          </div>
          <button type="button" (click)="playMessageTts(i)" mat-stroked-button class="tts-btn">
            üîä
          </button>
        </div>
      </div>
    </div>
  </div>

  <div style="display:flex; align-items:center; gap:12px; margin-top:8px;">
    <label style="font-size: 13px; display:flex; align-items:center; gap:6px; cursor:pointer;">
      <input type="checkbox" [checked]="ttsEnabled()" (change)="onTtsToggle($event)" />
      {{ lang()==='fr' ? 'Lire la r√©ponse (TTS)' : 'Read the answer (TTS)' }}
    </label>
  </div>

  <form (ngSubmit)="send()" class="input-row">
    <mat-form-field class="input-field" appearance="outline">
      <mat-label>{{ lang()==='fr' ? 'Votre message' : 'Your message' }}</mat-label>
      <input matInput [ngModel]="input()" (ngModelChange)="input.set($event)" name="msg" [disabled]="loading()"/>
    </mat-form-field>
    <button mat-stroked-button type="button" (click)="toggleRecording()" [disabled]="loading()" style="margin-right:8px;">
      {{ isRecording ? (lang()==='fr' ? 'Arr√™ter' : 'Stop') : (lang()==='fr' ? 'Parler' : 'Speak') }}
    </button>
    <button mat-raised-button color="primary" type="submit" [disabled]="loading() || !input().trim()">
      {{ lang()==='fr' ? 'Envoyer' : 'Send' }}
    </button>
  </form>
  <div *ngIf="isRecording" style="font-size: 12px; color: #e53935; margin-top: 4px;">
    {{ lang()==='fr' ? 'Enregistrement en cours‚Ä¶' : 'Recording‚Ä¶' }}
  </div>
</div>
