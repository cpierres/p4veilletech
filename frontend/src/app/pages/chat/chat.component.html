<div class="chat-container">
  <div class="chat-header">
    <h2>Chatbot IA - Christophe Pierr√®s</h2>
    <div class="chat-controls">
      <mat-form-field appearance="outline" class="provider-select">
        <mat-label>Fournisseur IA</mat-label>
        <mat-select [(ngModel)]="provider" (ngModelChange)="provider = $event">
          <mat-option value="mistral-cloud">Mistral AI Cloud</mat-option>
          <mat-option value="openai">OpenAI</mat-option>
          <mat-option value="mistral">Mistral (Local)</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="model-select">
        <mat-label>Mod√®le</mat-label>
        <mat-select [(ngModel)]="model" (ngModelChange)="model = $event">
          <mat-option *ngFor="let opt of availableModels()" [value]="opt.value">
            {{ opt.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-icon-button (click)="toggleHistory()" [matTooltip]="showHistory() ? 'Masquer l\'historique' : 'Afficher l\'historique'" class="history-toggle">
        <mat-icon>{{ showHistory() ? 'history_off' : 'history' }}</mat-icon>
      </button>
    </div>
  </div>

  <div class="chat-main">
    <!-- Panneau de conversation principal -->
    <div class="chat-messages" #messagesContainer>
      <div *ngFor="let message of messages(); let i = index" [class]="'message ' + message.role">
        <div class="message-header">
          <span class="message-role">{{ message.role === 'user' ? 'Vous' : 'Assistant' }}</span>
          <span class="message-time">{{ getProcessingTime(message) }}</span>
        </div>
        <div class="message-content" [innerHTML]="renderMarkdown(getMessageText(message))"></div>
        <div *ngIf="message.metadata" class="message-metadata">
          <span *ngIf="message.metadata.provider" class="metadata-badge provider-badge">
            {{ message.metadata.provider }}: {{ message.metadata.model }}
          </span>
          <span *ngIf="message.metadata.temperature" class="metadata-badge temp-badge">
            Temp: {{ message.metadata.temperature }}
          </span>
          <span *ngIf="message.conversationId" class="metadata-badge conv-id-badge" matTooltip="ID de conversation enregistr√©">
            üíæ {{ getShortConversationId(message) }}
          </span>
        </div>
      </div>
    </div>

    <!-- Panneau d'historique -->
    <div *ngIf="showHistory()" class="history-panel">
      <div class="history-header">
        <h3>Historique des conversations</h3>
        <button mat-icon-button (click)="loadConversationHistory()" [disabled]="loadingHistory()" matTooltip="Rafra√Æchir l'historique">
          <mat-icon>{{ loadingHistory() ? 'sync' : 'refresh' }}</mat-icon>
        </button>
      </div>

      <div *ngIf="loadingHistory()" class="history-loading">
        <mat-icon class="spin">sync</mat-icon>
        <span>Chargement...</span>
      </div>

      <div *ngIf="!loadingHistory() && conversationHistory().length === 0" class="no-history">
        Aucun historique de conversation trouv√©.
      </div>

      <div *ngFor="let conv of conversationHistory()" class="history-item">
        <div class="history-item-header">
          <span class="history-item-date">{{ conv.createdAt | date:'medium' }}</span>
          <div class="history-item-actions">
            <button mat-icon-button (click)="showConversation(conv)" matTooltip="Afficher cette conversation">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button (click)="deleteConversation(conv.id)" matTooltip="Supprimer cette conversation">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
        <div class="history-item-content">
          <div class="history-item-message user-message">
            <strong>Vous:</strong> {{ conv.userMessage | slice:0:100 }}{{ conv.userMessage.length > 100 ? '...' : '' }}
          </div>
          <div class="history-item-message assistant-message">
            <strong>Assistant:</strong> {{ conv.assistantResponse | slice:0:150 }}{{ conv.assistantResponse.length > 150 ? '...' : '' }}
          </div>
        </div>
        <div class="history-item-metadata">
          <span class="metadata-badge provider-badge">
            {{ conv.provider }}: {{ conv.model }}
          </span>
          <span *ngIf="conv.temperature" class="metadata-badge temp-badge">
            Temp: {{ conv.temperature }}
          </span>
        </div>
      </div>
    </div>

    <!-- Zone d'entr√©e -->
    <div class="chat-input">
      <div class="input-controls">
        <button mat-icon-button (click)="toggleRecording()" [color]="isRecording ? 'warn' : 'primary'" matTooltip="Enregistrement vocal">
          <mat-icon>{{ isRecording ? 'stop' : 'mic' }}</mat-icon>
        </button>

        <mat-form-field appearance="outline" class="chat-input-field">
          <mat-label>Votre message</mat-label>
          <input matInput [(ngModel)]="input" (ngModelChange)="input = $event"
                 (keyup.enter)="send()" [disabled]="loading()">
        </mat-form-field>

        <button mat-icon-button (click)="send()" [disabled]="loading() || !_input().trim()" matTooltip="Envoyer le message">
          <mat-icon>send</mat-icon>
        </button>
      </div>

      <div class="advanced-settings">
        <button mat-button (click)="showAdvancedSettings.set(!showAdvancedSettings())">
          <mat-icon>{{ showAdvancedSettings() ? 'expand_less' : 'expand_more' }}</mat-icon>
          {{ showAdvancedSettings() ? 'Masquer' : 'Afficher' }} les param√®tres avanc√©s
        </button>

        <div *ngIf="showAdvancedSettings()" class="advanced-settings-content">
          <div class="settings-row">
            <mat-form-field appearance="outline" class="setting-field">
              <mat-label>Temp√©rature</mat-label>
              <input matInput type="number" step="0.1" min="0" max="1"
                     [(ngModel)]="temperature" (ngModelChange)="temperature = $event">
            </mat-form-field>

            <mat-form-field appearance="outline" class="setting-field">
              <mat-label>Top P</mat-label>
              <input matInput type="number" step="0.1" min="0" max="1"
                     [(ngModel)]="topP" (ngModelChange)="topP = $event">
            </mat-form-field>

            <mat-form-field appearance="outline" class="setting-field">
              <mat-label>Max Tokens</mat-label>
              <input matInput type="number" min="1"
                     [(ngModel)]="maxTokens" (ngModelChange)="maxTokens = $event">
            </mat-form-field>
          </div>

          <div class="settings-row">
            <mat-form-field appearance="outline" class="setting-field">
              <mat-label>RAG Top K</mat-label>
              <input matInput type="number" min="1" max="100"
                     [(ngModel)]="ragTopK" (ngModelChange)="ragTopK = $event">
            </mat-form-field>

            <mat-form-field appearance="outline" class="setting-field">
              <mat-label>Seuil de similarit√©</mat-label>
              <input matInput type="number" step="0.01" min="0" max="1"
                     [(ngModel)]="ragSimilarityThreshold" (ngModelChange)="ragSimilarityThreshold = $event">
            </mat-form-field>
          </div>

          <div class="settings-row">
            <mat-slide-toggle [(ngModel)]="ttsEnabled" (ngModelChange)="onTtsToggle($event)">
              Lecture vocale automatique (TTS)
            </mat-slide-toggle>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="loading()" class="loading-overlay">
    <mat-icon class="spin">sync</mat-icon>
    <span>L'assistant est en train de r√©fl√©chir...</span>
  </div>
</div>
